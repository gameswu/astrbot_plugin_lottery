# 抽奖算法文档

本文档详细介绍了 AstrBot 抽奖插件所使用的抽奖算法。

## 概述

抽奖系统支持三种不同的概率模式，每种模式都有其特定的适用场景和算法实现。通过灵活配置这些模式，可以满足不同类型的抽奖需求。

## 抽奖流程

### 基础流程

1. **参与限制检查**
   - 检查抽奖状态（必须为 ACTIVE）
   - 验证总参与人数限制
   - 验证用户抽奖次数限制
   - 验证用户中奖次数限制

2. **中奖判定**
   - 根据概率模式计算中奖概率
   - 使用随机数判断是否中奖
   - 若中奖，进入奖品选择流程

3. **奖品选择**
   - 获取用户可中奖的奖品列表
   - 根据权重算法选择具体奖品
   - 更新奖品库存和用户记录

## 概率模式

### 1. Fixed 模式（固定概率）

**适用场景：** 传统抽奖，中奖概率固定不变

**描述：**

```text
中奖概率 = base_probability（恒定值）
```

**特点：**

- 中奖概率始终等于配置的 `base_probability`
- 不受参与人数、剩余奖品数量等因素影响
- 适用于长期运行的抽奖活动

**示例：**
如果设置 `base_probability = 0.2`，则每次抽奖都有 20% 的中奖概率。

### 2. Dynamic 模式（动态概率）

**适用场景：** 预留扩展功能，当前实现与 Fixed 模式相同

### 3. Exhaust 模式（消耗完毕模式）

**适用场景：** 希望尽量抽完所有奖品的活动

**描述：**

该模式的核心思想是动态调整中奖概率，确保在抽奖结束前尽可能消耗完所有有限量奖品。

#### 3.1 剩余中奖次数计算

```text
剩余中奖次数 = 现有用户剩余中奖次数 + 新用户可能中奖次数

其中：
现有用户剩余中奖次数 = Σ min(max_wins_per_user - 已中奖次数, max_attempts_per_user - 已抽奖次数)
新用户可能中奖次数 = (max_total_participants - 当前参与人数) × min(max_wins_per_user, max_attempts_per_user)
```

#### 3.2 动态概率计算

```text
if 剩余奖品总数 <= 0:
    中奖概率 = base_probability
elif 剩余中奖次数 <= 0:
    中奖概率 = 0
elif 剩余奖品总数 >= 剩余中奖次数:
    中奖概率 = 1.0
else:
    所需概率 = 剩余奖品总数 / 剩余中奖次数
    中奖概率 = max(base_probability, 所需概率)
```

**特点：**

- 保证中奖概率不低于设定的基础概率
- 当剩余奖品数量大于等于剩余可能中奖次数时，确保 100% 中奖

**示例：**

- 总奖品：100 个
- 剩余奖品：20 个
- 剩余中奖次数：50 次
- 基础概率：0.1

计算：所需概率 = 20/50 = 0.4
最终概率 = max(0.1, 0.4) = 0.4 (40%)

## 奖品选择

### 权重

当用户中奖后，系统使用基于权重的随机选择算法来确定具体获得哪个奖品。

**算法步骤：**

1. **筛选可用奖品**

   ```text
   对于每个奖品：
   - 检查库存：quantity > 0 且 remaining_quantity > 0
   - 检查用户限制：用户已获得该奖品次数 < max_win_per_user
   ```

2. **权重随机选择**

   ```text
   总权重 = Σ(可用奖品.weight)
   随机值 = random.randint(1, 总权重)
   
   累计权重 = 0
   for 奖品 in 可用奖品列表:
       累计权重 += 奖品.weight
       if 随机值 <= 累计权重:
           return 奖品
   ```

## 参与限制机制

### 限制类型

1. **总参与人数限制** (`max_total_participants`)
   - 限制抽奖活动的总参与人数
   - 设置为 0 表示无限制

2. **用户抽奖次数限制** (`max_attempts_per_user`)
   - 限制单个用户可以参与抽奖的最大次数
   - 包括中奖和未中奖的次数

3. **用户中奖次数限制** (`max_wins_per_user`)
   - 限制单个用户可以中奖的最大次数
   - 防止单个用户获得过多奖品

4. **奖品个人限制** (`max_win_per_user`)
   - 限制单个用户可以获得同一奖品的最大数量
   - 每个奖品可以单独设置

### 检查顺序

系统按以下顺序检查各项限制：

1. 抽奖状态检查
2. 总参与人数检查
3. 用户抽奖次数检查
4. 用户中奖次数检查
5. 奖品库存和个人限制检查（在奖品选择阶段）

## 配置建议

### Fixed 模式配置

```json
{
  "probability_mode": "fixed",
  "base_probability": 0.1
}
```

**建议：**

- 适用于长期运行的抽奖
- `base_probability` 设置为较低值（0.05-0.2）

### Exhaust 模式配置

```json
{
  "probability_mode": "exhaust", 
  "base_probability": 0.05
}
```

**建议：**

- 适用于有明确结束时间的活动
- `base_probability` 可设置较低，系统会自动调整
- 合理设置参与限制，确保算法有足够的调整空间

## 注意事项

1. **无限量奖品：** 设置 `quantity = -1` 的奖品不参与 Exhaust 模式的动态概率计算

2. **概率下限：** Exhaust 模式计算的概率不会低于 `base_probability`
